---
title: "Homework 3 Assignment"
author: yb2334
output: html_document
published: false
tags: hw3
---

**A. Survey Source**

World Values Survey Wave 3 (1995-1999) & Wave 5 (2005-2009)

Question wording: Do you agree or disagree with the following statement? Marriage is an out-dated institution. (V94 in Wave 3 and V58 in Wave 5)

**B. Preliminary Graph Description**

I plan to plot two maps showing the distribution of respondents' answers to this question of each country, and another bar plot demonstrating the difference between two waves. I expect that there is a contrast between the West and the East, yet this difference will shrink in Wave 5. 

**C. Data Target Shape**

Country: 1, 1, ...   

Wave: 3, 3, 3, ..., 5, 5, ...   

Mean value: 1.3, 1.6, 1.7, ...

Continent: Asia, Asia, ..., Europe, ...


**D. Script**
```{r, message=FALSE}
## Load packages
library(reshape2)
library(ggplot2)
library(RColorBrewer)
library(plyr)
library(sp)
library(rCharts)
library(rworldmap)
```

```{r}
## Read data
load("E:/QMSS/Data Visualization/WV3_Data_rdata_v_2014_09_21/WV3_Data_rdata_v_2014_09_21.rdata")
wv3 <- WV3_Data_rdata_v_2014_09_21
load("E:/QMSS/Data Visualization/WV5_Data_rdata_v_2014_04_28/WV5_Data_rdata_v_2014_04_28.rdata")
wv5 <- WV5_Data_spss_v_2014_04_28
```

```{r}
## Take a look at interested variables
str(wv3$V2)
sum(is.na(wv3$V2))

str(wv3$V94)
table(wv3$V94)
sum(is.na(wv3$V94))

str(wv5$V2)
sum(is.na(wv5$V2))

str(wv5$V58)
table(wv5$V58)
sum(is.na(wv5$V58))
```

```{r}
## Find out how they are coded
lapply(attributes(wv3), length)
attr(wv3, 'var.labels')[[110]]
attr(wv3, 'label.table')[[110]]
name1 <- attr(wv3, 'label.table')[[2]]

lapply(attributes(wv5), length)
attr(wv5, 'var.labels')[[91]]
attr(wv5, 'label.table')[[91]]
name2 <- attr(wv5, 'label.table')[[4]]

## Check the consistency of country coding
setdiff(name1, name2)
```

```{r}
## Subset data
wv3_sub <- subset(wv3, select = c(V2, V94), V94 > 0)
wv5_sub <- subset(wv5, select = c(V2, V58), V58 > 0)

## Recode variable so that 1 indicates "agree" and 0 indicates "disagree" and the mean value of each country shows the proportion of people agree that marriage in an out-dated institution.
table(wv3_sub$V94)
wv3_sub$V94[wv3_sub$V94 == 2] <- 0
table(wv3_sub$V94)

table(wv5_sub$V58)
wv5_sub$V58[wv5_sub$V58 == 2] <- 0
table(wv5_sub$V58)
```

```{r}
## Calculate mean of each country
wv3_agg <- aggregate(wv3_sub$V94, by = list(wv3_sub$V2), FUN = "mean")
colnames(wv3_agg) <- c("Country", "MarrOut")
wv5_agg <- aggregate(wv5_sub$V58, by = list(wv5_sub$V2), FUN = "mean")
colnames(wv5_agg) <- c("Country", "MarrOut")

## Replace country code with country name
wv3_agg$Country <- names(name1)[match(wv3_agg$Country, name1)]
wv5_agg$Country <- names(name2)[match(wv5_agg$Country, name2)]
```

```{r}
## Merge data that have both wave 3 and both 5 records
data_all <- merge(wv3_agg, wv5_agg, by = "Country")
colnames(data_all) <- c("Country", "Wave_3", "Wave_5")
data_all <- melt(data_all, id.vars = "Country", measure.vars = c("Wave_3", "Wave_5"), variable.name = "Wave")

## Add a column indicating continent
Asia <- c("China", "India", "South Korea", "Taiwan")
NAmer <- c("Mexico", "United States")
SAmer <- c("Argentina", "Chile", "Peru", "Uruguay")
Europe <- c("Bulgaria", "Finland", "Georgia", "Germany", "Hungary", "Moldova", "Norway", "Poland", "Romania", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey", "Ukraine")
Africa <- c("South Africa")
Aus <- c("Australia", "New Zealand")
data_all$Continent[data_all$Country %in% Asia] <- "Asia"
data_all$Continent[data_all$Country %in% NAmer] <- "North America"
data_all$Continent[data_all$Country %in% SAmer] <- "South America"
data_all$Continent[data_all$Country %in% Europe] <- "Europe"
data_all$Continent[data_all$Country %in% Africa] <- "Africa"
data_all$Continent[data_all$Country %in% Aus] <- "Australia"
```

**E. Plot Graphs**
```{r}
## Plot 1 for Wave 3 data
color <- brewer.pal(7, "Reds")
joinCountryData2Map( wv3_agg, joinCode = "NAME", nameJoinColumn = "Country", verbose = T)
wv3_agg$Country[wv3_agg$Country == "Czech Rep."] <- "Czech Republic"
wv3_agg$Country[wv3_agg$Country == "Dominican Rep."] <- "Dominican Republic"
plot1 <- joinCountryData2Map( wv3_agg, joinCode = "NAME", nameJoinColumn = "Country", verbose = F)
par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")
map1 <- mapCountryData(plot1, nameColumnToPlot = "MarrOut", colourPalette = color, addLegend = F, mapTitle = "Proportion of People Agree Marriage is an Out-Dated Institution (Wave 3)")
do.call(addMapLegend
        , c(map1
            ,legendLabels="all"
            ,legendWidth = 0.4))
```

```{r}
## Plot 2 for Wave 5 data
plot2 <- joinCountryData2Map( wv5_agg, joinCode = "NAME", nameJoinColumn = "Country", verbose = T)
par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")
map2 <- mapCountryData(plot2, nameColumnToPlot = "MarrOut", colourPalette = color, addLegend = F, mapTitle = "Proportion of People Agree Marriage is an Out-Dated Institution (Wave 5)")
do.call(addMapLegend
        , c(map2
            ,legendLabels="all"
            ,legendWidth = 0.4))
```

```{r, fig.height=8, fig.width=12}
## Plot 3 for comparing Wave 3 and Wave 5
plot3 <- ggplot(data_all, aes(x = Country, y = value, group = Wave, fill = Wave)) +
  geom_bar(stat = "identity", position="dodge") +
  xlab(" ") +
  ylab(" ") +
  ggtitle("Proportion of People Agree Marriage is an Out-Dated Institution") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ Continent, scales = "free_x")
print(plot3)
```

**F. Write Descriptive Function Calls**
```{r, eval=FALSE}
loadData1( )
survey1 <- selectVariables(survey1, )
survey1 <- transformData(survey1, )
plot1 <- PlotData(survey1, )

loadData2( )
survey2 <- selectVariables(survey2, )
survey2 <- transformData(survey2, )
plot2 <- PlotData(survey2, )

data_all <- combineData(survey1, survey2, )
plot3 <- ggplot(data_all, aes())
```

**H. Write Actual Function Calls**
```{r, eval=FALSE}
loadData1 <- function(filepath) {
  load(filepath)
  Survey1 <- WV3_Data_rdata_v_2014_09_21
}

loadData2 <- function(filepath) {
  load(filepath)
  Survey2 <- WV5_Data_spss_v_2014_04_28
}

selectVariables <- function(Survey, variable) {
  Survey <- subset(Survey, select = c(V2, variable), variable > 0)
  Survey$variable[Survey$variable == 2] <- 0
}

transformData <- function(Survey, variable) {
  Survey <- aggregate(Survey$variable, by = list(Survey$V2), FUN = "mean")
  colnames(Survey) <- c("Country", "MarrOut")
  if (Survey == Survey1) {
    name <- attr(Survey, 'label.table')[[2]]
    }
  name <- attr(Survey, 'label.table')[[4]]
  Survey$Country <- names(name)[match(Survey$Country, name)]
}

plotData <- function(Survey) {
  require(RColorBrewer)
  require(plyr)
  require(rCharts)
  require(rworldmap)
  color <- brewer.pal(7, "Reds")
  Survey$Country[Survey$Country == "Czech Rep."] <- "Czech Republic"
  Survey$Country[Survey$Country == "Dominican Rep."] <- "Dominican Republic"
  plot <- joinCountryData2Map( Survey, joinCode = "NAME", nameJoinColumn = "Country", verbose = F)
  par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")
  map <- mapCountryData(plot, nameColumnToPlot = "MarrOut", colourPalette = color, addLegend = F, mapTitle = "Proportion of People Agree Marriage is an Out-Dated Institution")
do.call(addMapLegend
        , c(map2
            ,legendLabels="all"
            ,legendWidth = 0.4))
  return(map)
}

combineData <- function(Survey1, Survey2) {
  require(reshape2)
  data_all <- merge(Survey1, Survey2, by = "Country")
  colnames(data_all) <- c("Country", "Wave_3", "Wave_5")
  data_all <- melt(data_all, id.vars = "Country", measure.vars = c("Wave_3", "Wave_5"), variable.name = "Wave")
  Asia <- c("China", "India", "South Korea", "Taiwan")
  NAmer <- c("Mexico", "United States")
  SAmer <- c("Argentina", "Chile", "Peru", "Uruguay")
  Europe <- c("Bulgaria", "Finland", "Georgia", "Germany", "Hungary", "Moldova", "Norway", "Poland", "Romania", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey", "Ukraine")
  Africa <- c("South Africa")
  Aus <- c("Australia", "New Zealand")
  data_all$Continent[data_all$Country %in% Asia] <- "Asia"
  data_all$Continent[data_all$Country %in% NAmer] <- "North America"
  data_all$Continent[data_all$Country %in% SAmer] <- "South America"
  data_all$Continent[data_all$Country %in% Europe] <- "Europe"
  data_all$Continent[data_all$Country %in% Africa] <- "Africa"
  data_all$Continent[data_all$Country %in% Aus] <- "Australia"
}

plot3 <- ggplot(data_all, aes(x = Country, y = value, group = Wave, fill = Wave)) +
  geom_bar(stat = "identity", position="dodge") +
  xlab(" ") +
  ylab(" ") +
  ggtitle("Proportion of People Agree Marriage is an Out-Dated Institution") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ Continent, scales = "free_x")
print(plot3)
```